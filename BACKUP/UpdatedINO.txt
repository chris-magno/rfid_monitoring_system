#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <SPI.h>
#include <MFRC522.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <ArduinoJson.h> // <<--- For JSON parsing

// --- Pin Configuration ---
#define SS_PIN D2
#define RST_PIN D1
#define ELOCK_PIN D0
#define BUZZER_PIN D0

// --- RFID ---
MFRC522 mfrc522(SS_PIN, RST_PIN);

// --- LCD ---
LiquidCrystal_I2C lcd(0x27, 16, 2);

// --- WiFi ---
const char* ssid = "Kaela";
const char* password = "Kaela0221";

// --- Server Paths ---
String serverPath = "http://192.168.100.69/rfid_monitoring_system/api/getUID.php";
String mailPath   = "http://192.168.100.69/rfid_monitoring_system/api/send_mail.php";

// --- Variables ---
bool lockState = false;
int failedAttempts = 0;

// ======================================================
// SETUP
// ======================================================
void setup() {
  Serial.begin(115200);
  Wire.begin(D3,D4);
  lcd.init();
  lcd.backlight();
  SPI.begin();
  mfrc522.PCD_Init();
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(ELOCK_PIN, OUTPUT);
  digitalWrite(ELOCK_PIN, HIGH); // locked initially

  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("Connecting WiFi");
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("WiFi Connected!");
  lcd.setCursor(0,1);
  lcd.print("Scan your card");
  Serial.println("System Ready...");
}

// ======================================================
// LOOP
// ======================================================
void loop() {
  if (!mfrc522.PICC_IsNewCardPresent()) return;
  if (!mfrc522.PICC_ReadCardSerial()) return;

  digitalWrite(BUZZER_PIN, HIGH);

  // Read UID
  String uidString = "";
  for (byte i = 0; i < mfrc522.uid.size; i++) {
    uidString += String(mfrc522.uid.uidByte[i], HEX);
  }
  uidString.toUpperCase();

  Serial.print("Card UID: "); Serial.println(uidString);

  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("UID:"); lcd.print(uidString);

  // --- Send UID to server and get response ---
  String serverResponse = sendUID(uidString);

  // --- Parse JSON properly ---
  StaticJsonDocument<200> doc;
  DeserializationError error = deserializeJson(doc, serverResponse);

  String cardName = "Unknown";
  bool isRegistered = false;

  if (!error) {
      const char* name = doc["name"];
      if (name != nullptr && strlen(name) > 0) {
          isRegistered = true;
          cardName = String(name);
      }
  }

  lcd.setCursor(0,1);
  lcd.print(cardName);

  // --- Access control ---
  if (isRegistered) {
      failedAttempts = 0;
      lockState = !lockState;

      lcd.clear();
      lcd.setCursor(0,0);
      lcd.print("Access Granted");
      lcd.setCursor(0,1);
      if (lockState) {
          lcd.print("Unlocked ‚úÖ");
          digitalWrite(ELOCK_PIN, LOW);
      } else {
          lcd.print("Locked üîí");
          digitalWrite(ELOCK_PIN, HIGH);
      }
  } else {
      failedAttempts++;
      lcd.clear();
      lcd.setCursor(0,0);
      lcd.print("Access Denied");
      lcd.setCursor(0,1);
      lcd.print("Try Again ‚ùå");

      if (failedAttempts >= 3) {
          sendEmailAlert(uidString);
          failedAttempts = 0;
      }
  }

  mfrc522.PICC_HaltA();
  mfrc522.PCD_StopCrypto1();
  delay(1500);
}

// ======================================================
// Function: Send UID to server
// ======================================================
String sendUID(String uid) {
  if (WiFi.status() == WL_CONNECTED) {
    WiFiClient client;
    HTTPClient http;

    String postData = "UIDresult=" + uid;
    http.begin(client, serverPath);
    http.addHeader("Content-Type", "application/x-www-form-urlencoded");

    int httpCode = http.POST(postData);
    String payload = http.getString();

    Serial.print("UID Response: "); Serial.println(payload);
    http.end();
    return payload;
  } else {
    Serial.println("‚ö†Ô∏è WiFi Disconnected");
    return "";
  }
}

// ======================================================
// Function: Send Email Alert (after 3 failed attempts)
// ======================================================
void sendEmailAlert(String uid) {
  if (WiFi.status() == WL_CONNECTED) {
    WiFiClient client;
    HTTPClient http;

    String postData = "uid=" + uid;
    http.begin(client, mailPath);
    http.addHeader("Content-Type", "application/x-www-form-urlencoded");

    int httpCode = http.POST(postData);
    String payload = http.getString();

    Serial.print("üìß Email Response: "); Serial.println(payload);
    http.end();
  } else {
    Serial.println("‚ö†Ô∏è WiFi Disconnected. Cannot send Email Alert.");
  }
}
